<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Matrix Bot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <!-- Three Column Layout Container -->
    <div class="dashboard-container">
        
        <!-- Left Sidebar (260px) -->
        <aside class="sidebar">
            <div class="brand">
                <span class="brand-icon">ğŸ¤–</span>
                <span>TG Matrix Bot</span>
            </div>
            
            <!-- Global Stats Pills -->
            <div class="stats-container">
                <div class="stat-pill">
                    <span class="stat-label">æ´»è·ƒæœºå™¨äºº</span>
                    <span class="stat-value" id="g_active">0</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-label">ä»Šæ—¥æ¶ˆæ¯</span>
                    <span class="stat-value" id="g_msg">0</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-label">è´¦å·æ•°</span>
                    <span class="stat-value" id="g_acc">0</span>
                </div>
            </div>
            
            <!-- Account List -->
            <div class="account-list-header">
                <span>ğŸ“‹ è´¦å·åˆ—è¡¨</span>
                <span class="account-count" id="accountCount">0</span>
            </div>
            <div class="account-list" id="accountList"></div>
            
            <!-- FAB Add Button -->
            <button class="fab-add" onclick="showModal()" title="æ·»åŠ è´¦å·">
                <span>+</span>
            </button>
        </aside>
        
        <!-- Center Panel - Config with Tabs -->
        <main class="center-panel" id="mainArea">
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-illustration">
                    <svg viewBox="0 0 200 200" width="140" height="140">
                        <defs>
                            <linearGradient id="emptyGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#334155;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <!-- Robot Body -->
                        <rect x="50" y="60" width="100" height="120" rx="16" fill="url(#emptyGrad)" stroke="#475569" stroke-width="2"/>
                        <!-- Robot Head -->
                        <rect x="60" y="20" width="80" height="55" rx="10" fill="url(#emptyGrad)" stroke="#475569" stroke-width="2"/>
                        <!-- Eyes -->
                        <circle cx="85" cy="42" r="8" fill="#1e293b" stroke="#64748b" stroke-width="2"/>
                        <circle cx="115" cy="42" r="8" fill="#1e293b" stroke="#64748b" stroke-width="2"/>
                        <circle cx="85" cy="42" r="4" fill="#10b981"/>
                        <circle cx="115" cy="42" r="4" fill="#10b981"/>
                        <!-- Antenna -->
                        <line x1="100" y1="20" x2="100" y2="5" stroke="#475569" stroke-width="2"/>
                        <circle cx="100" cy="3" r="5" fill="#3b82f6"/>
                        <!-- Arms -->
                        <rect x="25" y="75" width="25" height="15" rx="6" fill="#334155"/>
                        <rect x="150" y="75" width="25" height="15" rx="6" fill="#334155"/>
                        <!-- Legs -->
                        <rect x="65" y="175" width="18" height="30" rx="6" fill="#334155"/>
                        <rect x="117" y="175" width="18" height="30" rx="6" fill="#334155"/>
                    </svg>
                </div>
                <div class="empty-content">
                    <h2 class="empty-title">ğŸ¤– æ¬¢è¿ä½¿ç”¨ TG Matrix Bot</h2>
                    <p class="empty-hint">æš‚æ— æ´»è·ƒæœºå™¨äºº</p>
                    <p class="empty-subhint">ç‚¹å‡»å³ä¸‹è§’ + æŒ‰é’®æ·»åŠ æ–°è´¦å·</p>
                </div>
                <!-- Quick Stats Card when empty -->
                <div class="empty-stats-card">
                    <div class="stats-card-header">
                        <span class="stats-icon">ğŸ“Š</span>
                        <span class="stats-title">è¿è¡Œç»Ÿè®¡</span>
                    </div>
                    <div class="stats-card-body">
                        <div class="stat-row">
                            <span class="stat-label">çŠ¶æ€</span>
                            <span class="stat-value-simple" id="emptyStatus">ğŸŸ¢ å¾…å‘½ä¸­</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ä»Šæ—¥æ¶ˆæ¯</span>
                            <span class="stat-value-simple">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">å‚ä¸æŠ½å¥–</span>
                            <span class="stat-value-simple">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">è¿è¡Œæ—¶é—´</span>
                            <span class="stat-value-simple">0h 0m</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Right Panel - Monitor/Stats (360px) -->
        <aside class="right-panel">
            <!-- Control Center -->
            <div class="control-center">
                <div class="control-header">
                    <span class="control-icon">ğŸ›ï¸</span>
                    <span class="control-title">æ§åˆ¶ä¸­å¿ƒ</span>
                </div>
                <div class="control-buttons">
                    <button class="btn btn-primary btn-start-water" onclick="startBot('water')" title="å¼€å§‹æ°´ç¾¤">
                        <span class="btn-icon">ğŸŸ¢</span>
                        <span class="btn-text">â–¶ å¼€å§‹æ°´ç¾¤</span>
                    </button>
                    <button class="btn btn-gift btn-start-giveaway" onclick="startBot('giveaway')" title="å¼€å§‹æŠ½å¥–">
                        <span class="btn-icon">ğŸ¯</span>
                        <span class="btn-text">å¼€å§‹æŠ½å¥–</span>
                    </button>
                    <button class="btn btn-secondary" onclick="stopBot('water')" title="æš‚åœ">
                        <span class="btn-icon">â¸ï¸</span>
                        <span class="btn-text">æš‚åœ</span>
                    </button>
                    <button class="btn btn-secondary" onclick="saveConfig()" title="ä¿å­˜é…ç½®">
                        <span class="btn-icon">ğŸ’¾</span>
                        <span class="btn-text">ä¿å­˜é…ç½®</span>
                    </button>
                    <button class="btn btn-danger" onclick="deleteAccount()" title="åˆ é™¤è´¦å·">
                        <span class="btn-icon">ğŸ—‘ï¸</span>
                        <span class="btn-text">åˆ é™¤è´¦å·</span>
                    </button>
                </div>
            </div>
            
            <!-- Real-time Log Terminal -->
            <div class="log-section">
                <div class="log-header">
                    <span class="log-icon">ğŸ“‹</span>
                    <span class="log-title">å®æ—¶æ—¥å¿—</span>
                    <div class="log-actions">
                        <button class="btn-icon-small" onclick="clearLogs()" title="æ¸…ç©º">ğŸ—‘ï¸</button>
                        <button class="btn-icon-small" onclick="toggleAutoScroll()" id="autoScrollBtn" title="è‡ªåŠ¨æ»šåŠ¨">ğŸ“œ</button>
                    </div>
                </div>
                <div class="terminal" id="logTerminal">
                    <div class="terminal-placeholder">
                        <span class="terminal-icon">ğŸ’¬</span>
                        <p>ç­‰å¾…æ—¥å¿—è¾“å…¥...</p>
                    </div>
                </div>
            </div>
            
            <!-- Stats Card -->
            <div class="stats-section">
                <div class="stats-card">
                    <div class="stats-card-header">
                        <span class="stats-icon">ğŸ“Š</span>
                        <span class="stats-title">è¿è¡Œç»Ÿè®¡</span>
                        <span class="status-badge" id="botStatus">ğŸ”´ å·²åœæ­¢</span>
                    </div>
                    <div class="stats-card-body" id="statsCardBody">
                        <div class="stat-row">
                            <span class="stat-label">çŠ¶æ€</span>
                            <span class="stat-value-simple" id="statStatus">ğŸ”´ å·²åœæ­¢</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ä»Šæ—¥æ¶ˆæ¯</span>
                            <span class="stat-value-simple" id="statMessages">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">å‚ä¸æŠ½å¥–</span>
                            <span class="stat-value-simple" id="statGiveaways">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">è¿è¡Œæ—¶é—´</span>
                            <span class="stat-value-simple" id="statUptime">0h 0m</span>
                        </div>
                        <div class="activity-row">
                            <span class="stat-label">æ´»è·ƒåº¦</span>
                            <div class="activity-bar-container">
                                <div class="activity-bar" id="activityBar" style="width: 0%"></div>
                            </div>
                            <span class="activity-value" id="activityValue">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Sticky Save Button Bar -->
    <div class="sticky-save-bar" id="stickySaveBar" style="display: none;">
        <div class="save-bar-content">
            <span class="save-bar-label">âš ï¸ å·²ä¿®æ”¹é…ç½®ï¼Œè®°å¾—ä¿å­˜å“¦ï½</span>
            <div class="save-bar-buttons">
                <button class="btn btn-secondary" onclick="discardChanges()">æ”¾å¼ƒ</button>
                <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ è´¦å·å¼¹çª— -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ¤– æ·»åŠ  Telegram è´¦å·</h2>
                <button class="modal-close" onclick="hideModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ğŸ“± æ‰‹æœºå·</label>
                    <input type="text" class="form-input" id="loginPhone" placeholder="+86...">
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label class="form-label">ğŸ”‘ API ID</label>
                        <input type="number" class="form-input" id="loginApiId" value="32841554">
                    </div>
                    <div class="form-col">
                        <label class="form-label">ğŸ” API Hash</label>
                        <input type="text" class="form-input" id="loginApiHash" value="bd3793da28922b292d34b3db68ccacf7">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸŒ SOCKS5 ä»£ç†</label>
                    <input type="text" class="form-input" id="loginProxy" placeholder="127.0.0.1:1080:user:pass">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addAccount()">â• æ·»åŠ è´¦å·</button>
            </div>
        </div>
    </div>

    <!-- æŠ½å¥–è¡¥å½•å¼¹çª— -->
    <div class="modal-overlay" id="backfillModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ æŠ½å¥–è¡¥å½•</h2>
                <button class="modal-close" onclick="hideBackfillModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ğŸ“… é€‰æ‹©å›æº¯å¤©æ•°</label>
                    <div class="day-options">
                        <button class="day-btn" onclick="selectDays(this, 1)">1å¤©</button>
                        <button class="day-btn" onclick="selectDays(this, 2)">2å¤©</button>
                        <button class="day-btn" onclick="selectDays(this, 3)">3å¤©</button>
                        <button class="day-btn" onclick="selectDays(this, 7)">7å¤©</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ å½“å‰è´¦å·</label>
                    <div class="account-badge" id="backfillPhone">--</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideBackfillModal()">å–æ¶ˆ</button>
                <button class="btn btn-gift" onclick="runBackfill()">ğŸš€ å¼€å§‹è¡¥å½•</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentPhone = null;
        let selectedBackfillDays = 1;
        let logBuffer = [];
        const MAX_LOG_LINES = 500;
        let configModified = false;
        let autoScroll = true;
        let uptimeSeconds = 0;
        let uptimeInterval = null;
        
        // å…¨å±€ç»Ÿè®¡
        setInterval(async () => {
            try {
                const res = await fetch('/api/stats/global');
                const d = await res.json();
                document.getElementById('g_active').innerText = d.active_bots || 0;
                document.getElementById('g_msg').innerText = d.total_messages || 0;
                document.getElementById('g_acc').innerText = d.total_accounts || 0;
            } catch {}
        }, 5000);
        
        // WebSocketæ—¥å¿—æ¥æ”¶
        socket.on('log_update', data => {
            const timestamp = data.timestamp ? data.timestamp.split('T')[1].split('.')[0] : '00:00:00';
            const line = `[${timestamp}] ${data.message}`;
            const level = data.level || 'info';
            logBuffer.push({ text: line, level: level.toLowerCase() });
            if (logBuffer.length > MAX_LOG_LINES) {
                logBuffer.shift();
            }
            renderLogs();
        });
        
        function renderLogs() {
            const term = document.getElementById('logTerminal');
            if (!term) return;
            
            if (logBuffer.length === 0) {
                term.innerHTML = `
                    <div class="terminal-placeholder">
                        <span class="terminal-icon">ğŸ’¬</span>
                        <p>ç­‰å¾…æ—¥å¿—è¾“å…¥...</p>
                    </div>
                `;
                return;
            }
            
            term.innerHTML = logBuffer.map(l => 
                `<div class="log-line log-${l.level}">${escapeHtml(l.text)}</div>`
            ).join('');
            
            if (autoScroll) {
                term.scrollTop = term.scrollHeight;
            }
        }
        
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('autoScrollBtn');
            btn.style.opacity = autoScroll ? '1' : '0.5';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function loadAccounts() {
            const res = await fetch('/api/accounts');
            const list = await res.json();
            const container = document.getElementById('accountList');
            container.innerHTML = list.map(acc => `
                <div class="account-item ${currentPhone === acc.phone ? 'active' : ''}" 
                     onclick="renderMain('${acc.phone}')">
                    <div class="status-indicator ${acc.water_running ? 'running' : (acc.paused ? 'paused' : 'stopped')}"></div>
                    <div class="account-info">
                        <span class="acc-phone">${acc.phone}</span>
                        <span class="acc-status">${acc.water_running ? 'è¿è¡Œä¸­' : (acc.paused ? 'å·²æš‚åœ' : 'å·²åœæ­¢')}</span>
                    </div>
                </div>
            `).join('');
            
            // Update account count
            const countEl = document.getElementById('accountCount');
            if (countEl) countEl.innerText = list.length;
        }
        
        async function renderMain(phone) {
            currentPhone = phone;
            configModified = false;
            updateStickyBar();
            logBuffer = [];
            uptimeSeconds = 0;
            if (uptimeInterval) clearInterval(uptimeInterval);
            
            const html = `
                <!-- Account Header -->
                <div class="account-header">
                    <div class="account-info-large">
                        <span class="account-icon">ğŸ“±</span>
                        <div class="account-details">
                            <span class="account-title">${phone}</span>
                            <span class="account-subtitle" id="accountSubtitle">å·²åœæ­¢</span>
                        </div>
                    </div>
                    <div class="account-actions">
                        <button class="btn btn-gift" onclick="showBackfillModal()">ğŸ æŠ½å¥–è¡¥å½•</button>
                    </div>
                </div>
                
                <!-- Tab Navigation -->
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-btn active" data-tab="basic">
                            <span class="tab-icon">âš™ï¸</span>
                            <span class="tab-label">åŸºç¡€è®¾ç½®</span>
                        </button>
                        <button class="tab-btn" data-tab="giveaway">
                            <span class="tab-icon">ğŸ</span>
                            <span class="tab-label">æŠ½å¥–/è¿‡æ»¤</span>
                        </button>
                        <button class="tab-btn" data-tab="ai">
                            <span class="tab-icon">ğŸ§ </span>
                            <span class="tab-label">AI/æ—¶é—´</span>
                        </button>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Tab 1: åŸºç¡€è®¾ç½® -->
                        <div class="tab-panel active" id="tab-basic">
                            <div class="config-card">
                                <div class="card-header">
                                    <h3 class="card-title">ğŸŒ ç½‘ç»œé…ç½®</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-col">
                                            <label class="form-label">SOCKS5 ä»£ç†</label>
                                            <input type="text" class="form-input" id="conf_proxy" placeholder="host:port:user:pass" onchange="markModified()">
                                        </div>
                                        <div class="form-col">
                                            <label class="form-label">ğŸ“º ç›‘æ§é¢‘é“</label>
                                            <input type="text" class="form-input" id="conf_monitor" placeholder="Haifpcj" onchange="markModified()">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="config-card">
                                <div class="card-header">
                                    <h3 class="card-title">ğŸ‘¥ ç›®æ ‡ç¾¤ç»„</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">ç›®æ ‡ç¾¤ç»„ (æ¯è¡Œä¸€ä¸ª)</label>
                                        <textarea class="form-textarea" id="conf_groups" style="height:120px;" placeholder="https://t.me/group_name" onchange="markModified()"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="config-card">
                                <div class="card-header">
                                    <h3 class="card-title">âš–ï¸ è´¦å·æƒé‡</h3>
                                </div>
                                <div class="card-body">
                                    <div class="weight-control">
                                        <label class="form-label">æƒé‡è°ƒèŠ‚</label>
                                        <div class="weight-slider-container">
                                            <input type="range" class="weight-slider" id="conf_weight" min="1" max="10" value="1" oninput="updateWeightDisplay(this.value); markModified()">
                                            <div class="weight-display">
                                                <span class="weight-value" id="weight_val">1</span>
                                                <span class="weight-label">å€</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab 2: æŠ½å¥–/è¿‡æ»¤ -->
                        <div class="tab-panel" id="tab-giveaway">
                            <div class="config-card">
                                <div class="card-header">
                                    <h3 class="card-title">ğŸ å…³é”®è¯è¿‡æ»¤</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">
                                            âœ… å…è®¸å…³é”®è¯ 
                                            <span class="preset-dropdown">
                                                <select class="preset-select" onchange="loadPreset(this.value, 'allow')">
                                                    <option value="">ğŸ“‚ åŠ è½½é¢„è®¾...</option>
                                                    <option value="basic">åŸºç¡€æŠ½å¥–</option>
                                                    <option value="phone">æ‰‹æœºç±»</option>
                                                    <option value="tech">æ•°ç ç§‘æŠ€</option>
                                                </select>
                                            </span>
                                        </label>
                                        <textarea class="form-textarea" id="conf_allow" placeholder="å‚åŠ æŠ½å¥–&#10;æŠ½å¥–é“¾æ¥&#10;éšæœºæŠ½å–" onchange="markModified()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">âŒ å±è”½å…³é”®è¯ (æ¯è¡Œä¸€ä¸ª)</label>
                                        <textarea class="form-textarea" id="conf_block" placeholder="å·²ç»“æŸ&#10;åé¢å·²æ»¡&#10;é»‘åå•" onchange="markModified()"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="config-card">
                                <div class="card-header">
                                    <h3 class="card-title">ğŸ’¬ System Prompt</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">å®šä¹‰æœºå™¨äººçš„è¡Œä¸ºå’Œå¯¹è¯é£æ ¼</label>
                                        <textarea class="form-textarea" id="conf_prompt" style="height:100px;" placeholder="ä½ æ˜¯ä¸€ä¸ªçƒ­æƒ…çš„ç¾¤èŠæˆå‘˜ï¼Œç»å¸¸å‚ä¸æŠ½å¥–æ´»åŠ¨..." onchange="markModified()"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab 3: AI/æ—¶é—´ -->
                        <div class="tab-panel" id="tab-ai">
                            <div class="config-card">
                                <div class="card-header">
                                    <h3 class="card-title">ğŸ§  DeepSeek AI é…ç½®</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">ğŸ”‘ API Key</label>
                                        <div class="password-input-container">
                                            <input type="password" class="form-input password-input" id="conf_ai_key" placeholder="sk-..." onchange="markModified()">
                                            <button class="password-toggle" onclick="togglePasswordVisibility('conf_ai_key')" title="æ˜¾ç¤º/éšè—">
                                                <span class="eye-icon">ğŸ‘ï¸</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-col">
                                            <label class="form-label">ğŸ“ æœ€å¤§é•¿åº¦</label>
                                            <input type="number" class="form-input" id="conf_ai_len" value="20" onchange="markModified()">
                                        </div>
                                        <div class="form-col">
                                            <label class="form-label">ğŸ“Š ä¸Šä¸‹æ–‡æ•°</label>
                                            <input type="number" class="form-input" id="conf_ctx" value="5" onchange="markModified()">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="config-card">
                                <div class="card-header">
                                    <h3 class="card-title">â±ï¸ æ—¶é—´è®¾ç½®</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-col">
                                            <label class="form-label">â³ æœ€å°é—´éš”(ç§’)</label>
                                            <input type="number" class="form-input" id="conf_min" value="120" onchange="validateTime(); markModified()">
                                        </div>
                                        <div class="form-col">
                                            <label class="form-label">â° æœ€å¤§é—´éš”(ç§’)</label>
                                            <input type="number" class="form-input" id="conf_max" value="240" onchange="validateTime(); markModified()">
                                        </div>
                                    </div>
                                    <div class="form-row" style="margin-top: 16px;">
                                        <div class="form-col">
                                            <label class="form-label">ğŸŒ™ ä¼‘çœ å¼€å§‹(æ—¶)</label>
                                            <input type="number" class="form-input" id="conf_sleep_s" value="0" min="0" max="23" onchange="validateTime(); markModified()">
                                        </div>
                                        <div class="form-col">
                                            <label class="form-label">â˜€ï¸ ä¼‘çœ ç»“æŸ(æ—¶)</label>
                                            <input type="number" class="form-input" id="conf_sleep_e" value="8" min="0" max="23" onchange="validateTime(); markModified()">
                                        </div>
                                    </div>
                                    <div class="time-error" id="timeError" style="display: none;">
                                        âš ï¸ ä¼‘çœ å¼€å§‹æ—¶é—´ä¸èƒ½ç­‰äºç»“æŸæ—¶é—´
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('mainArea').innerHTML = html;
            
            // Setup tab switching
            setupTabs();
            
            await loadConfig(phone);
            loadLogs(phone);
            updateStatsDisplay();
        }
        
        function setupTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    
                    // Update buttons
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Update panels
                    document.querySelectorAll('.tab-panel').forEach(panel => {
                        panel.classList.remove('active');
                    });
                    document.getElementById('tab-' + tabId).classList.add('active');
                });
            });
        }
        
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const toggle = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                toggle.innerHTML = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                toggle.innerHTML = 'ğŸ‘ï¸';
            }
        }
        
        function validateTime() {
            const sleepStart = parseInt(document.getElementById('conf_sleep_s').value) || 0;
            const sleepEnd = parseInt(document.getElementById('conf_sleep_e').value) || 8;
            const errorEl = document.getElementById('timeError');
            
            if (sleepStart === sleepEnd) {
                errorEl.style.display = 'block';
                return false;
            } else {
                errorEl.style.display = 'none';
                return true;
            }
        }
        
        function loadPreset(presetType, targetField) {
            if (!presetType) return;
            
            const presets = {
                'basic': ['å‚åŠ æŠ½å¥–', 'æŠ½å¥–é“¾æ¥', 'éšæœºæŠ½å–', 'ç«‹å³å‚ä¸', 'ç‚¹æˆ‘æŠ½'],
                'phone': ['iPhone', 'iPad', 'æ‰‹æœº', 'å¹³æ¿', 'æŠ½å¥–', 'å…è´¹é€'],
                'tech': ['iPhone', 'MacBook', 'Switch', 'PS5', 'æŠ½å¥–', 'æ•°ç ']
            };
            
            const keywords = presets[presetType] || [];
            if (keywords.length > 0) {
                document.getElementById(targetField === 'allow' ? 'conf_allow' : 'conf_block').value = keywords.join('\n');
                markModified();
            }
        }
        
        function updateWeightDisplay(value) {
            const display = document.getElementById('weight_val');
            if (display) display.innerText = value;
        }
        
        function markModified() {
            configModified = true;
            updateStickyBar();
        }
        
        function updateStickyBar() {
            const bar = document.getElementById('stickySaveBar');
            if (bar) {
                bar.style.display = configModified ? 'flex' : 'none';
            }
        }
        
        function discardChanges() {
            if (currentPhone) {
                loadConfig(currentPhone);
            }
            configModified = false;
            updateStickyBar();
        }
        
        function clearLogs() {
            logBuffer = [];
            renderLogs();
        }
        
        async function loadConfig(phone) {
            const res = await fetch(`/api/config/${phone}`);
            const d = await res.json();
            
            document.getElementById('conf_proxy').value = d.proxy || '';
            document.getElementById('conf_monitor').value = d.monitor_channel || '';
            document.getElementById('conf_ai_key').value = d.ai_key || '';
            document.getElementById('conf_ai_len').value = d.ai_max_length || 20;
            document.getElementById('conf_ctx').value = d.context_count || 5;
            document.getElementById('conf_min').value = d.min_delay || 120;
            document.getElementById('conf_max').value = d.max_delay || 240;
            document.getElementById('conf_sleep_s').value = d.sleep_start || 0;
            document.getElementById('conf_sleep_e').value = d.sleep_end || 8;
            document.getElementById('conf_groups').value = (d.target_groups || []).join('\n');
            document.getElementById('conf_prompt').value = d.system_prompt || '';
            document.getElementById('conf_allow').value = (d.allow_keywords || []).join('\n');
            document.getElementById('conf_block').value = (d.block_keywords || []).join('\n');
            document.getElementById('conf_weight').value = d.weight || 1;
            
            updateWeightDisplay(d.weight || 1);
        }
        
        async function saveConfig() {
            // Validate time settings
            if (!validateTime()) {
                showToast('âŒ è¯·å…ˆä¿®å¤æ—¶é—´è®¾ç½®é”™è¯¯');
                return;
            }
            
            const data = {
                proxy: document.getElementById('conf_proxy').value.trim(),
                monitor_channel: document.getElementById('conf_monitor').value.trim(),
                ai_key: document.getElementById('conf_ai_key').value.trim(),
                ai_max_length: parseInt(document.getElementById('conf_ai_len').value) || 20,
                context_count: parseInt(document.getElementById('conf_ctx').value) || 5,
                min_delay: parseInt(document.getElementById('conf_min').value) || 120,
                max_delay: parseInt(document.getElementById('conf_max').value) || 240,
                sleep_start: parseInt(document.getElementById('conf_sleep_s').value) || 0,
                sleep_end: parseInt(document.getElementById('conf_sleep_e').value) || 8,
                target_groups: document.getElementById('conf_groups').value.split('\n').map(s => s.trim()).filter(s => s),
                system_prompt: document.getElementById('conf_prompt').value,
                allow_keywords: document.getElementById('conf_allow').value.split('\n').map(s => s.trim()).filter(s => s),
                block_keywords: document.getElementById('conf_block').value.split('\n').map(s => s.trim()).filter(s => s),
                weight: parseInt(document.getElementById('conf_weight').value) || 1
            };
            
            await fetch(`/api/config/${currentPhone}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            configModified = false;
            updateStickyBar();
            showToast('âœ… é…ç½®ä¿å­˜æˆåŠŸ');
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        async function loadLogs(phone) {
            const res = await fetch(`/api/logs/${phone}`);
            const text = await res.text();
            logBuffer = [];
            text.split('\n').forEach(line => {
                if (line.trim()) {
                    let level = 'info';
                    if (line.includes('ERROR')) level = 'error';
                    else if (line.includes('WARNING')) level = 'warn';
                    logBuffer.push({ text: line.trim(), level });
                }
            });
            renderLogs();
        }
        
        async function startBot(type) {
            if (!currentPhone) {
                showToast('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè´¦å·');
                return;
            }
            
            if (type === 'water') {
                await fetch('/api/water/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({phone: currentPhone})
                });
            } else if (type === 'giveaway') {
                await fetch('/api/giveaway/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({phone: currentPhone})
                });
            }
            
            loadAccounts();
            updateStatsDisplay();
            startUptimeCounter();
        }
        
        async function stopBot(type) {
            if (!currentPhone) return;
            
            if (type === 'water') {
                await fetch('/api/water/stop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({phone: currentPhone})
                });
            }
            
            loadAccounts();
            updateStatsDisplay();
        }
        
        function startUptimeCounter() {
            uptimeSeconds = 0;
            if (uptimeInterval) clearInterval(uptimeInterval);
            uptimeInterval = setInterval(() => {
                uptimeSeconds++;
                const hours = Math.floor(uptimeSeconds / 3600);
                const minutes = Math.floor((uptimeSeconds % 3600) / 60);
                const uptimeEl = document.getElementById('statUptime');
                if (uptimeEl) uptimeEl.innerText = `${hours}h ${minutes}m`;
            }, 1000);
        }
        
        function updateStatsDisplay() {
            // Update status in right panel
            const statusEl = document.getElementById('statStatus');
            const statusBadge = document.getElementById('botStatus');
            const subtitle = document.getElementById('accountSubtitle');
            
            if (statusEl) {
                statusEl.innerHTML = '<span style="color: #64748b;">ğŸ”´ å·²åœæ­¢</span>';
            }
            if (statusBadge) {
                statusBadge.innerText = 'ğŸ”´ å·²åœæ­¢';
            }
            if (subtitle) {
                subtitle.innerText = 'å·²åœæ­¢';
            }
            
            // Reset activity bar
            const activityBar = document.getElementById('activityBar');
            const activityValue = document.getElementById('activityValue');
            if (activityBar) activityBar.style.width = '0%';
            if (activityValue) activityValue.innerText = '0%';
        }
        
        async function deleteAccount() {
            if (!currentPhone) return;
            if (confirm('ç¡®è®¤åˆ é™¤æ­¤è´¦å·ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                await fetch(`/api/accounts/${currentPhone}`, {method: 'DELETE'});
                currentPhone = null;
                document.getElementById('mainArea').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-illustration">
                            <svg viewBox="0 0 200 200" width="140" height="140">
                                <defs>
                                    <linearGradient id="emptyGrad2" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#334155;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect x="50" y="60" width="100" height="120" rx="16" fill="url(#emptyGrad2)" stroke="#475569" stroke-width="2"/>
                                <rect x="60" y="20" width="80" height="55" rx="10" fill="url(#emptyGrad2)" stroke="#475569" stroke-width="2"/>
                                <circle cx="85" cy="42" r="4" fill="#64748b"/>
                                <circle cx="115" cy="42" r="4" fill="#64748b"/>
                                <line x1="100" y1="20" x2="100" y2="5" stroke="#475569" stroke-width="2"/>
                                <circle cx="100" cy="3" r="5" fill="#64748b"/>
                                <rect x="25" y="75" width="25" height="15" rx="6" fill="#334155"/>
                                <rect x="150" y="75" width="25" height="15" rx="6" fill="#334155"/>
                                <rect x="65" y="175" width="18" height="30" rx="6" fill="#334155"/>
                                <rect x="117" y="175" width="18" height="30" rx="6" fill="#334155"/>
                            </svg>
                        </div>
                        <div class="empty-content">
                            <h2 class="empty-title">ğŸ¤– æ¬¢è¿ä½¿ç”¨ TG Matrix Bot</h2>
                            <p class="empty-hint">æš‚æ— æ´»è·ƒæœºå™¨äºº</p>
                            <p class="empty-subhint">ç‚¹å‡»å³ä¸‹è§’ + æŒ‰é’®æ·»åŠ æ–°è´¦å·</p>
                        </div>
                        <div class="empty-stats-card">
                            <div class="stats-card-header">
                                <span class="stats-icon">ğŸ“Š</span>
                                <span class="stats-title">è¿è¡Œç»Ÿè®¡</span>
                            </div>
                            <div class="stats-card-body">
                                <div class="stat-row">
                                    <span class="stat-label">çŠ¶æ€</span>
                                    <span class="stat-value-simple">ğŸŸ¢ å¾…å‘½ä¸­</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">ä»Šæ—¥æ¶ˆæ¯</span>
                                    <span class="stat-value-simple">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">å‚ä¸æŠ½å¥–</span>
                                    <span class="stat-value-simple">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">è¿è¡Œæ—¶é—´</span>
                                    <span class="stat-value-simple">0h 0m</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                loadAccounts();
            }
        }
        
        function showModal() { document.getElementById('loginModal').classList.add('show'); }
        function hideModal() { document.getElementById('loginModal').classList.remove('show'); }
        
        function showBackfillModal() {
            document.getElementById('backfillPhone').innerText = currentPhone;
            document.getElementById('backfillModal').classList.add('show');
            document.querySelectorAll('.day-btn').forEach((btn, i) => {
                btn.classList.toggle('selected', i === 0);
            });
            selectedBackfillDays = 1;
        }
        
        function hideBackfillModal() {
            document.getElementById('backfillModal').classList.remove('show');
        }
        
        function selectDays(btn, days) {
            document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedBackfillDays = days;
        }
        
        async function runBackfill() {
            hideBackfillModal();
            await fetch('/api/giveaway/backfill', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    phone: currentPhone,
                    days: selectedBackfillDays
                })
            });
            showToast('âœ… æŠ½å¥–è¡¥å½•ä»»åŠ¡å·²å¯åŠ¨');
        }
        
        async function addAccount() {
            const data = {
                phone: document.getElementById('loginPhone').value,
                api_id: parseInt(document.getElementById('loginApiId').value),
                api_hash: document.getElementById('loginApiHash').value,
                proxy: document.getElementById('loginProxy').value
            };
            if (!data.phone) { alert('è¯·è¾“å…¥æ‰‹æœºå·'); return; }
            await fetch('/api/accounts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            hideModal();
            loadAccounts();
        }
        
        loadAccounts();
    </script>
</body>
</html>