<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG Matrix Bot - ä»»åŠ¡çœ‹æ¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <span class="brand-icon">ğŸ¤–</span>
                <span class="brand-text">TG Matrix Bot</span>
            </div>
            
            <!-- Global Stats -->
            <div class="global-stats">
                <div class="stat-pill">
                    <span class="stat-icon">ğŸŸ¢</span>
                    <span class="stat-value" id="g_active">0</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-icon">ğŸ’¬</span>
                    <span class="stat-value" id="g_msg">0</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-icon">ğŸ¯</span>
                    <span class="stat-value" id="g_giveaway">0</span>
                </div>
            </div>
            
            <!-- Account List -->
            <div class="account-list-header">
                <span>ğŸ“‹ è´¦å·çœ‹æ¿</span>
                <span class="account-count" id="accountCount">0</span>
            </div>
            <div class="account-list" id="accountList"></div>
            
            <!-- FAB (Left Side) -->
            <button class="fab-add-left" onclick="showModal()" title="æ·»åŠ è´¦å·">+</button>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Task Header: æ ¸å¿ƒå†³ç­– -->
            <div class="task-header" id="taskHeader">
                <div class="header-left">
                    <div class="account-status-card">
                        <div class="status-avatar">
                            <span class="avatar-icon">ğŸ“±</span>
                            <div class="breathing-indicator" id="breathingIndicator"></div>
                        </div>
                        <div class="account-brief">
                            <span class="brief-phone" id="briefPhone">é€‰æ‹©è´¦å·</span>
                            <span class="brief-status" id="briefStatus">ç­‰å¾…æ¿€æ´»</span>
                        </div>
                    </div>
                </div>
                
                <div class="header-center">
                    <!-- Health Metrics -->
                    <div class="health-metrics">
                        <div class="metric-item">
                            <span class="metric-label">å¥åº·åº¦</span>
                            <div class="metric-bar">
                                <div class="metric-fill" id="healthBar" style="width: 100%"></div>
                            </div>
                            <span class="metric-value" id="healthValue">100%</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">æ´»è·ƒåº¦</span>
                            <span class="metric-value" id="activityLevel">é€‚ä¸­</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">ä»Šæ—¥æ”¶ç›Š</span>
                            <span class="metric-value" id="todayEarnings">0 æ¬¡æŠ½å¥–</span>
                        </div>
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="btn btn-primary btn-large" onclick="startAll()" id="startAllBtn">
                        <span class="btn-icon">â–¶ï¸</span>
                        <span class="btn-text">å¯åŠ¨ä»»åŠ¡</span>
                    </button>
                    <button class="btn btn-secondary btn-large" onclick="stopAll()" id="stopAllBtn" style="display:none">
                        <span class="btn-icon">â¸ï¸</span>
                        <span class="btn-text">æš‚åœä»»åŠ¡</span>
                    </button>
                </div>
            </div>
            
            <!-- Main Body: æ¼æ–—å¼å¸ƒå±€ -->
            <div class="task-body">
                
                <!-- Main Left: è¡Œä¸ºç­–ç•¥ -->
                <div class="main-left">
                    
                    <!-- Strategy Card: System Prompt -->
                    <div class="strategy-card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ­ äººè®¾ç­–ç•¥</h3>
                            <div class="preset-buttons">
                                <button class="preset-btn" onclick="loadPrompt('è·¯äºº')">ğŸ‘¤ è·¯äºº</button>
                                <button class="preset-btn" onclick="loadPrompt('æ°´å†›')">ğŸ­ æ°´å†›</button>
                                <button class="preset-btn" onclick="loadPrompt('ä¸“ä¸š')">ğŸ’¼ ä¸“ä¸š</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Risk Indicator -->
                            <div class="risk-indicator">
                                <span class="risk-label">å°å·é£é™©ï¼š</span>
                                <div class="risk-bar">
                                    <div class="risk-fill" id="riskBar" style="width: 30%"></div>
                                </div>
                                <span class="risk-value" id="riskValue">ä½</span>
                            </div>
                            
                            <!-- Prompt Input -->
                            <textarea class="strategy-input" id="strategyPrompt" 
                                placeholder="å®šä¹‰æœºå™¨äººçš„æ€§æ ¼å’Œå¯¹è¯é£æ ¼..."
                                oninput="updateRiskLevel()"></textarea>
                        </div>
                    </div>
                    
                    <!-- Trigger Keywords -->
                    <div class="keywords-card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ¯ è§¦å‘å…³é”®è¯</h3>
                        </div>
                        <div class="card-body">
                            <div class="keywords-section">
                                <label class="section-label">âœ… ç›‘æ§å…³é”®è¯ - æŠ½å¥–</label>
                                <div class="keyword-hint">æ£€æµ‹æŠ½å¥–æ¶ˆæ¯çš„å…³é”®è¯</div>
                                <div id="allowTagsContainer" class="keyword-input-area"></div>
                                <textarea id="conf_allow" style="display:none" onchange="markModified()"></textarea>
                            </div>
                            <div class="keywords-section">
                                <label class="section-label">ğŸš« å±è”½å…³é”®è¯ - å…¨éƒ¨</label>
                                <div class="keyword-hint">å±è”½æ‰€æœ‰ä»»åŠ¡çš„å…³é”®è¯</div>
                                <div id="blockTagsContainer" class="keyword-input-area"></div>
                                <textarea id="conf_block" style="display:none" onchange="markModified()"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Right: ç›®æ ‡ç®¡ç† -->
                <div class="main-right">
                    
                    <!-- Target Groups -->
                    <div class="target-card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ‘¥ ç›®æ ‡ç¾¤ç»„</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group compact">
                                <label class="form-label">ğŸ“º ç›‘æ§é¢‘é“</label>
                                <input type="text" class="form-input" id="conf_monitor" 
                                    placeholder="Haifpcj" onchange="markModified()">
                            </div>
                            <div class="form-group compact">
                                <label class="form-label">ğŸ¯ ç›®æ ‡ç¾¤ç»„ (æ¯è¡Œä¸€ä¸ª)</label>
                                <textarea class="form-textarea" id="conf_groups" 
                                    style="height:100px" 
                                    placeholder="https://t.me/group_name"
                                    onchange="markModified()"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Network & API (Collapsible) -->
                    <div class="settings-card collapsible" id="settingsCard">
                        <div class="card-header" onclick="toggleSettings()">
                            <h3 class="card-title">âš™ï¸ ç½‘ç»œä¸ API</h3>
                            <span class="toggle-icon" id="settingsToggle">â–¼</span>
                        </div>
                        <div class="card-body" id="settingsBody" style="display:none">
                            <div class="form-grid-2">
                                <div class="form-group compact">
                                    <label class="form-label">ğŸ”’ SOCKS5 ä»£ç†</label>
                                    <input type="text" class="form-input" id="conf_proxy" 
                                        placeholder="host:port:user:pass" onchange="markModified()">
                                </div>
                                <div class="form-group compact">
                                    <label class="form-label">ğŸ”‘ DeepSeek API</label>
                                    <div class="password-input-container">
                                        <input type="password" class="form-input" id="conf_ai_key" 
                                            placeholder="sk-..." onchange="markModified()">
                                        <button class="password-toggle" onclick="togglePassword('conf_ai_key')">ğŸ‘ï¸</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-grid-2">
                                <div class="form-group compact">
                                    <label class="form-label">â±ï¸ æœ€å°å»¶è¿Ÿ</label>
                                    <input type="number" class="form-input" id="conf_min" value="120" onchange="markModified()">
                                </div>
                                <div class="form-group compact">
                                    <label class="form-label">â±ï¸ æœ€å¤§å»¶è¿Ÿ</label>
                                    <input type="number" class="form-input" id="conf_max" value="240" onchange="markModified()">
                                </div>
                            </div>
                            <div class="form-row">
                                <button class="btn btn-secondary" onclick="saveConfig()">
                                    ğŸ’¾ ä¿å­˜é…ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backfill -->
                    <div class="backfill-card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“œ å†å²è¡¥å½•</h3>
                        </div>
                        <div class="card-body">
                            <div class="backfill-actions">
                                <select class="form-select" id="backfillDays">
                                    <option value="1">æ˜¨å¤©</option>
                                    <option value="3">æœ€è¿‘3å¤©</option>
                                    <option value="7">æœ€è¿‘7å¤©</option>
                                </select>
                                <button class="btn btn-gift" onclick="runBackfill()">
                                    ğŸš€ æ‰«æè¡¥å½•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Right Panel: Event Console -->
        <aside class="right-panel" id="rightPanel">
            <button class="close-toggle" onclick="toggleRightPanel()">Ã—</button>
            
            <div class="console-header">
                <span class="console-title">ğŸ“Š äº‹ä»¶ç›‘æ§</span>
                <div class="console-stats">
                    <span class="console-stat success" id="successCount">âœ“ 0</span>
                    <span class="console-stat warning" id="warningCount">âš  0</span>
                    <span class="console-stat error" id="errorCount">âœ— 0</span>
                </div>
            </div>
            
            <div class="console-body" id="consoleBody">
                <div class="console-empty" id="consoleEmpty">
                    <span class="empty-icon">â³</span>
                    <p>ç­‰å¾…äº‹ä»¶...</p>
                </div>
            </div>
            
            <div class="console-footer">
                <button class="btn-icon-small" onclick="clearConsole()" title="æ¸…ç©º">ğŸ—‘ï¸</button>
                <label class="auto-scroll-toggle">
                    <input type="checkbox" id="autoScrollConsole" checked onchange="toggleConsoleScroll()">
                    è‡ªåŠ¨æ»šåŠ¨
                </label>
            </div>
        </aside>
        
        <button class="right-panel-toggle" id="rightPanelToggle" onclick="toggleRightPanel()">ğŸ“Š</button>
        
        <!-- Add Account Modal -->
        <div class="modal-overlay" id="loginModal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">ğŸ¤– æ·»åŠ  Telegram è´¦å·</h2>
                    <button class="modal-close" onclick="hideModal()">Ã—</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">ğŸ“± æ‰‹æœºå·</label>
                        <input type="text" class="form-input" id="loginPhone" placeholder="+86...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ”¢ API ID</label>
                        <input type="number" class="form-input" id="loginApiId" placeholder="123456">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ”‘ API Hash</label>
                        <input type="text" class="form-input" id="loginApiHash" placeholder="abc123...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ”’ SOCKS5 ä»£ç† (å¯é€‰)</label>
                        <input type="text" class="form-input" id="loginProxy" placeholder="host:port:user:pass">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="addAccount()">â• æ·»åŠ è´¦å·</button>
                </div>
            </div>
        </div>
        
        <!-- Toast -->
        <div id="toastContainer"></div>
    </div>
    
    <script>
        // ==================== State ====================
        let currentPhone = null;
        let configModified = false;
        let logBuffer = [];
        let consoleEvents = [];
        let eventCounts = { success: 0, warning: 0, error: 0 };
        let autoScrollConsole = true;
        let uptimeSeconds = 0;
        let uptimeInterval = null;
        
        // Prompt Presets
        const promptPresets = {
            'è·¯äºº': 'ä½ æ˜¯ä¸€ä¸ªå®‰é™çš„ç¾¤èŠæˆå‘˜ï¼Œå¹³æ—¶å¾ˆå°‘è¯´è¯ï¼Œåªåœ¨çœ‹åˆ°æŠ½å¥–é“¾æ¥æ—¶æ‰ä¼šæ´»è·ƒå‚ä¸ã€‚',
            'æ°´å†›': 'ä½ æ˜¯ä¸€ä¸ªæ´»è·ƒçš„ç¾¤èŠæˆå‘˜ï¼Œç»å¸¸å‘è¨€èŠå¤©ï¼Œçƒ­è¡·äºå‚ä¸å„ç§æŠ½å¥–æ´»åŠ¨ï¼Œæ€§æ ¼å¼€æœ—å¥è°ˆã€‚',
            'ä¸“ä¸š': 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ½å¥–çˆ±å¥½è€…ï¼Œç²¾é€šå„ç§æŠ½å¥–æŠ€å·§ï¼Œå‚ä¸æŠ½å¥–æ—¶è®¤çœŸä»”ç»†ï¼Œä»ä¸æ”¾è¿‡ä»»ä½•æœºä¼šã€‚'
        };
        
        // ==================== Socket ====================
        const socket = io();
        
        socket.on('connect', () => {
            addConsoleEvent('success', 'ç³»ç»Ÿ', 'å·²è¿æ¥åˆ°æœåŠ¡å™¨');
        });
        
        socket.on('disconnect', () => {
            addConsoleEvent('warning', 'ç³»ç»Ÿ', 'ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
        });
        
        socket.on('log_update', data => {
            const level = data.level || 'info';
            const timestamp = data.timestamp ? data.timestamp.split('T')[1].split('.')[0] : '00:00:00';
            const line = `[${timestamp}] ${data.message}`;
            logBuffer.push({ text: line, level: level });
            
            // Categorize event
            if (level === 'success') {
                eventCounts.success++;
            } else if (level === 'error' || level === 'warn') {
                eventCounts.warning++;
            }
            updateConsoleCounts();
            
            renderConsole();
        });
        
        // ==================== Console Functions ====================
        function addConsoleEvent(type, source, message) {
            const time = new Date().toTimeString().split(' ')[0];
            const event = { type, source, message, time };
            consoleEvents.unshift(event);
            
            if (consoleEvents.length > 100) consoleEvents.pop();
            
            eventCounts[type]++;
            updateConsoleCounts();
            renderConsole();
        }
        
        function updateConsoleCounts() {
            document.getElementById('successCount').textContent = `âœ“ ${eventCounts.success}`;
            document.getElementById('warningCount').textContent = `âš  ${eventCounts.warning}`;
            document.getElementById('errorCount').textContent = `âœ— ${eventCounts.error}`;
        }
        
        function renderConsole() {
            const body = document.getElementById('consoleBody');
            const empty = document.getElementById('consoleEmpty');
            
            if (consoleEvents.length === 0) {
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            
            body.innerHTML = consoleEvents.map(e => `
                <div class="console-event ${e.type}">
                    <span class="event-time">${e.time}</span>
                    <span class="event-source">${e.source}</span>
                    <span class="event-message">${escapeHtml(e.message)}</span>
                </div>
            `).join('');
            
            if (autoScrollConsole) {
                body.scrollTop = 0;
            }
        }
        
        function clearConsole() {
            consoleEvents = [];
            eventCounts = { success: 0, warning: 0, error: 0 };
            updateConsoleCounts();
            renderConsole();
        }
        
        function toggleConsoleScroll() {
            autoScrollConsole = document.getElementById('autoScrollConsole').checked;
        }
        
        // ==================== Tag Input Component ====================
        class TagInput {
            constructor(containerId, hiddenInputId, tagType = 'allow') {
                this.container = document.getElementById(containerId);
                this.hiddenInput = document.getElementById(hiddenInputId);
                this.tagType = tagType;
                this.tags = [];
                this.init();
            }
            
            init() {
                if (!this.container) return;
                
                this.wrapper = document.createElement('div');
                this.wrapper.className = 'tag-input-wrapper';
                this.wrapper.innerHTML = `
                    <div class="tag-list"></div>
                    <input type="text" class="tag-input" placeholder="è¾“å…¥åæŒ‰å›è½¦">
                `;
                this.container.appendChild(this.wrapper);
                
                this.tagList = this.wrapper.querySelector('.tag-list');
                this.input = this.wrapper.querySelector('.tag-input');
                
                this.input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.addTag(this.input.value.trim());
                    }
                });
                
                this.input.addEventListener('blur', () => {
                    if (this.input.value.trim()) {
                        this.addTag(this.input.value.trim());
                    }
                });
            }
            
            addTag(value) {
                if (!value || this.tags.includes(value)) return;
                this.tags.push(value);
                this.render();
                this.updateHidden();
            }
            
            removeTag(index) {
                this.tags.splice(index, 1);
                this.render();
                this.updateHidden();
            }
            
            render() {
                const tagClass = this.tagType === 'block' ? 'tag tag-block' : 'tag tag-allow';
                this.tagList.innerHTML = this.tags.map((tag, i) => `
                    <span class="${tagClass}">
                        ${escapeHtml(tag)}
                        <span class="tag-remove" onclick="removeTagFromInput('${this.container.id}', ${i})">Ã—</span>
                    </span>
                `).join('');
            }
            
            updateHidden() {
                if (this.hiddenInput) {
                    this.hiddenInput.value = this.tags.join('\n');
                }
            }
            
            setTags(arr) {
                this.tags = Array.isArray(arr) ? arr : [];
                this.render();
                this.updateHidden();
            }
        }
        
        const tagInputs = {};
        
        function removeTagFromInput(containerId, index) {
            if (tagInputs[containerId]) {
                tagInputs[containerId].removeTag(index);
            }
        }
        
        function initTagInputs() {
            const allowContainer = document.getElementById('allowTagsContainer');
            const blockContainer = document.getElementById('blockTagsContainer');
            
            // åªåˆå§‹åŒ–ä¸€æ¬¡
            if (allowContainer && !tagInputs['allowTagsContainer']) {
                tagInputs['allowTagsContainer'] = new TagInput('allowTagsContainer', 'conf_allow', 'allow');
            }
            if (blockContainer && !tagInputs['blockTagsContainer']) {
                tagInputs['blockTagsContainer'] = new TagInput('blockTagsContainer', 'conf_block', 'block');
            }
        }
        
        // ==================== Prompt Functions ====================
        function loadPrompt(type) {
            const preset = promptPresets[type];
            if (preset) {
                document.getElementById('strategyPrompt').value = preset;
                updateRiskLevel();
                markModified();
                showToast(`å·²åŠ è½½ã€Œ${type}ã€äººè®¾`);
            }
        }
        
        function updateRiskLevel() {
            const prompt = document.getElementById('strategyPrompt').value;
            const riskBar = document.getElementById('riskBar');
            const riskValue = document.getElementById('riskValue');
            
            // Simple risk calculation
            let risk = 20;
            if (prompt.length > 100) risk += 10;
            if (prompt.includes('ç–¯ç‹‚') || prompt.includes('å¤§é‡')) risk += 20;
            if (prompt.includes('ç§’å›') || prompt.includes('ç«‹å³')) risk += 15;
            if (prompt.includes('å¹¿å‘Š')) risk += 25;
            risk = Math.min(risk, 100);
            
            riskBar.style.width = risk + '%';
            
            if (risk < 40) {
                riskValue.textContent = 'ä½ ğŸŸ¢';
                riskBar.style.background = '#10b981';
            } else if (risk < 70) {
                riskValue.textContent = 'ä¸­ ğŸŸ¡';
                riskBar.style.background = '#f59e0b';
            } else {
                riskValue.textContent = 'é«˜ ğŸ”´';
                riskBar.style.background = '#ef4444';
            }
        }
        
        // ==================== Account Functions ====================
        async function loadAccounts() {
            const res = await fetch('/api/accounts');
            const list = await res.json();
            
            document.getElementById('accountCount').textContent = list.length;
            document.getElementById('g_active').textContent = list.filter(a => a.water_running || a.giveaway_running).length;
            
            const container = document.getElementById('accountList');
            container.innerHTML = list.map(acc => `
                <div class="account-item ${currentPhone === acc.phone ? 'active' : ''}" 
                     onclick="selectAccount('${acc.phone}')">
                    <div class="item-indicator ${acc.giveaway_running ? 'running' : (acc.water_running ? 'running' : 'stopped')}"></div>
                    <div class="item-info">
                        <span class="item-phone">${acc.phone}</span>
                        <span class="item-status">${acc.giveaway_running ? 'æŠ½å¥–ä¸­' : (acc.water_running ? 'æ°´ç¾¤ä¸­' : 'å·²åœæ­¢')}</span>
                    </div>
                </div>
            `).join('');
        }
        
        async function selectAccount(phone) {
            // æ¸…ç©ºä¹‹å‰è´¦æˆ·çš„äº‹ä»¶æ—¥å¿—
            consoleEvents = [];
            eventCounts = { success: 0, warning: 0, error: 0 };
            updateConsoleCounts();
            renderConsole();
            
            currentPhone = phone;
            
            // å…ˆåˆå§‹åŒ–TagInput
            initTagInputs();
            
            // å†åŠ è½½é…ç½®ï¼ˆä¼šåœ¨é…ç½®ä¸­è®¾ç½®å…³é”®è¯ï¼‰
            await loadConfig(phone);
            
            loadConsoleHistory();
            updateHealthDisplay();
            
            // Update header
            document.getElementById('briefPhone').textContent = phone;
            document.getElementById('briefStatus').textContent = 'å°±ç»ª';
        }
        
        async function loadConfig(phone) {
            const res = await fetch(`/api/config/${phone}`);
            const d = await res.json();
            
            document.getElementById('conf_proxy').value = d.proxy || '';
            document.getElementById('conf_monitor').value = d.monitor_channel || '';
            document.getElementById('conf_ai_key').value = d.ai_key || '';
            document.getElementById('conf_min').value = d.min_delay || 120;
            document.getElementById('conf_max').value = d.max_delay || 240;
            document.getElementById('conf_groups').value = (d.target_groups || []).join('\n');
            document.getElementById('strategyPrompt').value = d.system_prompt || '';
            
            if (tagInputs['allowTagsContainer']) {
                tagInputs['allowTagsContainer'].setTags(d.allow_keywords || []);
            }
            if (tagInputs['blockTagsContainer']) {
                tagInputs['blockTagsContainer'].setTags(d.block_keywords || []);
            }
            
            updateRiskLevel();
        }
        
        async function saveConfig() {
            const data = {
                proxy: document.getElementById('conf_proxy').value.trim(),
                monitor_channel: document.getElementById('conf_monitor').value.trim(),
                ai_key: document.getElementById('conf_ai_key').value.trim(),
                min_delay: parseInt(document.getElementById('conf_min').value) || 120,
                max_delay: parseInt(document.getElementById('conf_max').value) || 240,
                target_groups: document.getElementById('conf_groups').value.split('\n').map(s => s.trim()).filter(s => s),
                system_prompt: document.getElementById('strategyPrompt').value,
                allow_keywords: tagInputs['allowTagsContainer']?.getTags() || [],
                block_keywords: tagInputs['blockTagsContainer']?.getTags() || []
            };
            
            await fetch(`/api/config/${currentPhone}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            configModified = false;
            showToast('âœ… é…ç½®å·²ä¿å­˜');
        }
        
        // ==================== Control Functions ====================
        async function startAll() {
            if (!currentPhone) {
                showToast('âŒ è¯·å…ˆé€‰æ‹©è´¦å·');
                return;
            }
            
            document.getElementById('startAllBtn').style.display = 'none';
            document.getElementById('stopAllBtn').style.display = 'flex';
            document.getElementById('breathingIndicator').classList.add('active');
            
            // Start water
            addConsoleEvent('success', 'ç³»ç»Ÿ', 'å¯åŠ¨æ°´ç¾¤ä»»åŠ¡...');
            await fetch('/api/water/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone: currentPhone})
            });
            
            // Start giveaway
            await fetch('/api/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone: currentPhone, type: 'giveaway'})
            });
            
            addConsoleEvent('success', 'ç³»ç»Ÿ', 'ä»»åŠ¡å·²å¯åŠ¨');
            startUptimeCounter();
        }
        
        async function stopAll() {
            if (!currentPhone) return;
            
            document.getElementById('startAllBtn').style.display = 'flex';
            document.getElementById('stopAllBtn').style.display = 'none';
            document.getElementById('breathingIndicator').classList.remove('active');
            
            await fetch('/api/water/stop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone: currentPhone})
            });
            
            await fetch('/api/stop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone: currentPhone, type: 'giveaway'})
            });
            
            addConsoleEvent('warning', 'ç³»ç»Ÿ', 'ä»»åŠ¡å·²æš‚åœ');
            stopUptimeCounter();
        }
        
        function startUptimeCounter() {
            uptimeSeconds = 0;
            if (uptimeInterval) clearInterval(uptimeInterval);
            uptimeInterval = setInterval(() => {
                uptimeSeconds++;
            }, 1000);
        }
        
        function stopUptimeCounter() {
            if (uptimeInterval) {
                clearInterval(uptimeInterval);
                uptimeInterval = null;
            }
        }
        
        // ==================== Backfill ====================
        async function runBackfill() {
            if (!currentPhone) {
                showToast('âŒ è¯·å…ˆé€‰æ‹©è´¦å·');
                return;
            }
            
            const days = parseInt(document.getElementById('backfillDays').value);
            
            addConsoleEvent('info', 'è¡¥å½•', `å¼€å§‹æ‰«ææœ€è¿‘${days}å¤©çš„æŠ½å¥–...`);
            
            await fetch('/api/giveaway/backfill', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone: currentPhone, days})
            });
            
            showToast('ğŸš€ è¡¥å½•ä»»åŠ¡å·²å¯åŠ¨');
        }
        
        // ==================== UI Helpers ====================
        function toggleSettings() {
            const body = document.getElementById('settingsBody');
            const icon = document.getElementById('settingsToggle');
            body.style.display = body.style.display === 'none' ? 'block' : 'none';
            icon.textContent = body.style.display === 'none' ? 'â–¼' : 'â–²';
        }
        
        function togglePassword(id) {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        
        function toggleRightPanel() {
            document.getElementById('rightPanel').classList.toggle('expanded');
        }
        
        function markModified() {
            configModified = true;
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function loadConsoleHistory() {
            if (!currentPhone) return;
            
            fetch(`/api/logs/${currentPhone}`)
                .then(res => res.text())
                .then(text => {
                    if (text && text !== 'æ— æ—¥å¿—å†…å®¹') {
                        const lines = text.split('\n').filter(l => l.trim());
                        lines.slice(-50).forEach(line => {
                            let type = 'info';
                            if (line.includes('æˆåŠŸ') || line.includes('âœ…')) type = 'success';
                            else if (line.includes('å¤±è´¥') || line.includes('é”™è¯¯') || line.includes('âŒ')) type = 'error';
                            else if (line.includes('è­¦å‘Š') || line.includes('âš ')) type = 'warning';
                            
                            const match = line.match(/\[(\d{2}:\d{2}:\d{2})\]/);
                            const time = match ? match[1] : '00:00:00';
                            
                            consoleEvents.unshift({ type, source: 'å†å²', message: line, time });
                            if (consoleEvents.length > 100) consoleEvents.pop();
                            eventCounts[type]++;
                        });
                        updateConsoleCounts();
                        renderConsole();
                    }
                });
        }
        
        function updateHealthDisplay() {
            // Update health metrics based on config
            const health = 100;
            const activity = 'é€‚ä¸­';
            const earnings = '0 æ¬¡æŠ½å¥–';
            
            document.getElementById('healthBar').style.width = health + '%';
            document.getElementById('healthValue').textContent = health + '%';
            document.getElementById('activityLevel').textContent = activity;
            document.getElementById('todayEarnings').textContent = earnings;
        }
        
        // ==================== Modal ====================
        function showModal() {
            document.getElementById('loginModal').classList.add('show');
        }
        
        function hideModal() {
            document.getElementById('loginModal').classList.remove('show');
        }
        
        async function addAccount() {
            const data = {
                phone: document.getElementById('loginPhone').value,
                api_id: parseInt(document.getElementById('loginApiId').value),
                api_hash: document.getElementById('loginApiHash').value,
                proxy: document.getElementById('loginProxy').value
            };
            
            if (!data.phone || !data.api_id || !data.api_hash) {
                showToast('âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            await fetch('/api/accounts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            hideModal();
            loadAccounts();
            showToast('âœ… è´¦å·æ·»åŠ æˆåŠŸ');
        }
        
        // ==================== Init ====================
        async function init() {
            await loadAccounts();
            
            // Global stats poll
            setInterval(async () => {
                try {
                    const res = await fetch('/api/stats/global');
                    const d = await res.json();
                    document.getElementById('g_active').textContent = d.active_bots || 0;
                    document.getElementById('g_msg').textContent = d.total_messages || 0;
                    document.getElementById('g_giveaway').textContent = d.total_giveaway_entries || 0;
                } catch {}
            }, 5000);
        }
        
        init();
    </script>
</body>
</html>
