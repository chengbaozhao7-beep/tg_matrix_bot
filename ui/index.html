<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Matrix Bot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 260px;
            background: #1e293b;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .brand {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: #fff;
            background: rgba(99,102,241,0.08);
            border-bottom: 1px solid #334155;
        }
        .stats {
            padding: 15px;
            font-size: 12px;
            border-bottom: 1px solid #334155;
        }
        .stats div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .stats .val { color: #10b981; }
        .stats .acc { color: #6366f1; }
        .account-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .account-item {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 4px;
        }
        .account-item:hover { background: rgba(255,255,255,0.05); }
        .account-item.active { background: rgba(99,102,241,0.15); border: 1px solid #6366f1; }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #475569;
            margin-right: 10px;
        }
        .status-dot.running { background: #10b981; animation: pulse 1.8s infinite; }
        .acc-phone { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .add-btn {
            margin: 15px;
            padding: 10px;
            background: #6366f1;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        .add-btn:hover { background: #4f46e5; }
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 30px 30px;
            overflow: hidden;
        }
        .empty {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: #94a3b8;
        }
        .top-bar {
            height: 60px;
            background: rgba(15,23,42,0.95);
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }
        .acc-title { font-size: 18px; font-weight: 600; font-family: 'JetBrains Mono'; }
        .controls { display: flex; gap: 10px; }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        .btn-start { background: rgba(16,185,129,0.1); color: #10b981; border: 1px solid rgba(16,185,129,0.2); }
        .btn-stop { background: rgba(239,68,68,0.1); color: #ef4444; border: 1px solid rgba(239,68,68,0.2); }
        .btn-save { background: #6366f1; color: #fff; }
        .btn:hover { opacity: 0.9; }
        .content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .config-panel {
            width: 500px;
            border-right: 1px solid #334155;
            overflow-y: auto;
            padding: 20px;
        }
        .log-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #334155;
        }
        .section-title {
            font-size: 11px;
            color: #6366f1;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .form-group { margin-bottom: 12px; }
        .label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 5px; }
        .input, .textarea {
            width: 100%;
            background: #0f172a;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 8px 10px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }
        .textarea { min-height: 60px; resize: vertical; }
        .row { display: flex; gap: 10px; }
        .row .flex { flex: 1; }
        .terminal {
            flex: 1;
            background: #000;
            padding: 15px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: #d4d4d4;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 rgba(16,185,129,0.3); }
            50% { box-shadow: 0 0 8px rgba(16,185,129,0.6); }
            100% { box-shadow: 0 0 0 rgba(16,185,129,0.3); }
        }
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            width: 400px;
            padding: 24px;
        }
        .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="brand">ü§ñ TG Matrix Bot</div>
        <div class="stats">
            <div><span>Active Bots</span><span class="val" id="g_active">0</span></div>
            <div><span>Total Msg</span><span class="val" id="g_msg">0</span></div>
            <div><span>Giveaway</span><span class="acc" id="g_gift">0</span></div>
        </div>
        <div class="account-list" id="accountList"></div>
        <button class="add-btn" onclick="showModal()">+ Ê∑ªÂä†Ë¥¶Âè∑</button>
    </div>
    
    <div class="main" id="mainArea">
        <div class="empty">ËØ∑ÈÄâÊã©Â∑¶‰æßË¥¶Âè∑ÊàñÊ∑ªÂä†Êñ∞Ë¥¶Âè∑</div>
    </div>
    
    <!-- Ê∑ªÂä†Ë¥¶Âè∑ÂºπÁ™ó -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-title">Ê∑ªÂä† Telegram Ë¥¶Âè∑</div>
            <div class="form-group">
                <label class="label">ÊâãÊú∫Âè∑</label>
                <input type="text" class="input" id="loginPhone" placeholder="+86...">
            </div>
            <div class="row">
                <div class="flex">
                    <label class="label">API ID</label>
                    <input type="number" class="input" id="loginApiId" value="32841554">
                </div>
                <div class="flex">
                    <label class="label">API Hash</label>
                    <input type="text" class="input" id="loginApiHash" value="bd3793da28922b292d34b3db68ccacf7">
                </div>
            </div>
            <div class="form-group">
                <label class="label">SOCKS5 ‰ª£ÁêÜ</label>
                <input type="text" class="input" id="loginProxy" placeholder="127.0.0.1:1080:user:pass">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn btn-stop" onclick="hideModal()">ÂèñÊ∂à</button>
                <button class="btn btn-save" onclick="addAccount()">Ê∑ªÂä†</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentPhone = null;
        let timerStats = null;
        
        // ÂÖ®Â±ÄÁªüËÆ°
        setInterval(async () => {
            try {
                const res = await fetch('/api/stats/global');
                const d = await res.json();
                document.getElementById('g_active').innerText = d.active_bots || 0;
                document.getElementById('g_msg').innerText = d.total_messages || 0;
                document.getElementById('g_gift').innerText = d.total_giveaway_entries || 0;
            } catch {}
        }, 5000);
        
        socket.on('log_update', data => {
            if (currentPhone && data.phone === currentPhone) {
                const term = document.getElementById('logTerminal');
                const lines = data.content.split(' ');
                lines.forEach(line => {
                    if (line.trim()) {
                        const div = document.createElement('div');
                        div.textContent = line;
                        term.appendChild(div);
                    }
                });
                term.scrollTop = term.scrollHeight;
            }
        });
        
        async function loadAccounts() {
            const res = await fetch('/api/accounts');
            const list = await res.json();
            const container = document.getElementById('accountList');
            container.innerHTML = list.map(acc => `
                <div class="account-item ${currentPhone === acc.phone ? 'active' : ''}" 
                     onclick="renderMain('${acc.phone}')">
                    <div class="status-dot ${acc.water_running || acc.giveaway_running ? 'running' : ''}"></div>
                    <span class="acc-phone">${acc.phone}</span>
                </div>
            `).join('');
        }
        
        async function renderMain(phone) {
            currentPhone = phone;
            const html = `
                <div class="top-bar">
                    <div class="acc-title">üì± ${phone}</div>
                    <div class="controls">
                        <button class="btn btn-start" onclick="startBot('water')">‚ñ∂ Ê∞¥Áæ§</button>
                        <button class="btn btn-stop" onclick="stopBot('water')">‚èπ</button>
                        <button class="btn btn-start" onclick="startBot('giveaway')">‚ñ∂ ÊäΩÂ•ñ</button>
                        <button class="btn btn-stop" onclick="stopBot('giveaway')">‚èπ</button>
                        <button class="btn btn-save" onclick="saveConfig()">üíæ ‰øùÂ≠ò</button>
                        <button class="btn btn-stop" onclick="deleteAccount()">üóë</button>
                    </div>
                </div>
                <div class="content">
                    <div class="config-panel" id="configPanel">
                        <div class="section">
                            <div class="section-title">üåê ÁΩëÁªúÈÖçÁΩÆ</div>
                            <div class="form-group">
                                <label class="label">SOCKS5 ‰ª£ÁêÜ</label>
                                <input type="text" class="input" id="conf_proxy" placeholder="host:port:user:pass">
                            </div>
                            <div class="form-group">
                                <label class="label">ÁõëÊéßÈ¢ëÈÅì</label>
                                <input type="text" class="input" id="conf_monitor" placeholder="Haifpcj">
                            </div>
                        </div>
                        <div class="section">
                            <div class="section-title">üéÅ ÊäΩÂ•ñËøáÊª§</div>
                            <div class="form-group">
                                <label class="label">ÂÖÅËÆ∏ÂÖ≥ÈîÆËØç</label>
                                <textarea class="textarea" id="conf_allow"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="label">Â±èËîΩÂÖ≥ÈîÆËØç</label>
                                <textarea class="textarea" id="conf_block"></textarea>
                            </div>
                        </div>
                        <div class="section">
                            <div class="section-title">üß† AIÈÖçÁΩÆ</div>
                            <div class="form-group">
                                <label class="label">DeepSeek API Key</label>
                                <input type="password" class="input" id="conf_ai_key" placeholder="sk-...">
                            </div>
                            <div class="row">
                                <div class="flex">
                                    <label class="label">ÊúÄÂ§ßÈïøÂ∫¶</label>
                                    <input type="number" class="input" id="conf_ai_len" value="20">
                                </div>
                                <div class="flex">
                                    <label class="label">‰∏ä‰∏ãÊñáÊï∞</label>
                                    <input type="number" class="input" id="conf_ctx" value="5">
                                </div>
                            </div>
                        </div>
                        <div class="section">
                            <div class="section-title">‚è±Ô∏è Êó∂Èó¥ËÆæÁΩÆ</div>
                            <div class="row">
                                <div class="flex">
                                    <label class="label">Âæ™ÁéØÈó¥Èöî(Áßí)</label>
                                    <input type="number" class="input" id="conf_min" value="120">
                                </div>
                                <div class="flex">
                                    <label class="label">ÊúÄÂ§ßÈó¥Èöî</label>
                                    <input type="number" class="input" id="conf_max" value="240">
                                </div>
                            </div>
                            <div class="row" style="margin-top:10px;">
                                <div class="flex">
                                    <label class="label">‰ºëÁú†ÂºÄÂßã</label>
                                    <input type="number" class="input" id="conf_sleep_s" value="0">
                                </div>
                                <div class="flex">
                                    <label class="label">‰ºëÁú†ÁªìÊùü</label>
                                    <input type="number" class="input" id="conf_sleep_e" value="8">
                                </div>
                            </div>
                        </div>
                        <div class="section">
                            <div class="section-title">üë• Áæ§ÁªÑÈÖçÁΩÆ</div>
                            <div class="form-group">
                                <label class="label">ÁõÆÊ†áÁæ§ÁªÑ (ÊØèË°å‰∏Ä‰∏™)</label>
                                <textarea class="textarea" id="conf_groups" style="height:100px;"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="label">System Prompt</label>
                                <textarea class="textarea" id="conf_prompt"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="log-panel">
                        <div class="terminal" id="logTerminal">Loading logs...</div>
                    </div>
                </div>
            `;
            document.getElementById('mainArea').innerHTML = html;
            await loadConfig(phone);
            loadLogs(phone);
        }
        
        async function loadConfig(phone) {
            const res = await fetch(`/api/config/${phone}`);
            const d = await res.json();
            document.getElementById('conf_proxy').value = d.proxy || '';
            document.getElementById('conf_monitor').value = d.monitor_channel || '';
            document.getElementById('conf_ai_key').value = d.ai_key || '';
            document.getElementById('conf_ai_len').value = d.ai_max_length || 20;
            document.getElementById('conf_ctx').value = d.context_count || 5;
            document.getElementById('conf_min').value = d.min_delay || 120;
            document.getElementById('conf_max').value = d.max_delay || 240;
            document.getElementById('conf_sleep_s').value = d.sleep_start || 0;
            document.getElementById('conf_sleep_e').value = d.sleep_end || 8;
            document.getElementById('conf_groups').value = (d.target_groups || []).join('\\n');
            document.getElementById('conf_prompt').value = d.system_prompt || '';
            document.getElementById('conf_allow').value = (d.allow_keywords || []).join('\\n');
            document.getElementById('conf_block').value = (d.block_keywords || []).join('\\n');
        }
        
        async function saveConfig() {
            const data = {
                proxy: document.getElementById('conf_proxy').value.trim(),
                monitor_channel: document.getElementById('conf_monitor').value.trim(),
                ai_key: document.getElementById('conf_ai_key').value.trim(),
                ai_max_length: parseInt(document.getElementById('conf_ai_len').value) || 20,
                context_count: parseInt(document.getElementById('conf_ctx').value) || 5,
                min_delay: parseInt(document.getElementById('conf_min').value) || 120,
                max_delay: parseInt(document.getElementById('conf_max').value) || 240,
                sleep_start: parseInt(document.getElementById('conf_sleep_s').value) || 0,
                sleep_end: parseInt(document.getElementById('conf_sleep_e').value) || 8,
                target_groups: document.getElementById('conf_groups').value.split('\\n').map(s => s.trim()).filter(s => s),
                system_prompt: document.getElementById('conf_prompt').value,
                allow_keywords: document.getElementById('conf_allow').value.split('\\n').map(s => s.trim()).filter(s => s),
                block_keywords: document.getElementById('conf_block').value.split('\\n').map(s => s.trim()).filter(s => s)
            };
            await fetch(`/api/config/${currentPhone}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            alert('‚úÖ ‰øùÂ≠òÊàêÂäü');
        }
        
        async function loadLogs(phone) {
            const res = await fetch(`/api/logs/${phone}`);
            const text = await res.text();
            document.getElementById('logTerminal').textContent = text || 'ÊöÇÊó†Êó•Âøó';
        }
        
        async function startBot(type) {
            await fetch('/api/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone: currentPhone, type})
            });
            loadAccounts();
        }
        
        async function stopBot(type) {
            await fetch('/api/stop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone: currentPhone, type})
            });
            loadAccounts();
        }
        
        async function deleteAccount() {
            if (confirm('Á°ÆËÆ§Âà†Èô§Ê≠§Ë¥¶Âè∑Ôºü')) {
                await fetch(`/api/accounts/${currentPhone}`, {method: 'DELETE'});
                currentPhone = null;
                document.getElementById('mainArea').innerHTML = '<div class="empty">ËØ∑ÈÄâÊã©Â∑¶‰æßË¥¶Âè∑</div>';
                loadAccounts();
            }
        }
        
        function showModal() { document.getElementById('loginModal').classList.add('show'); }
        function hideModal() { document.getElementById('loginModal').classList.remove('show'); }
        
        async function addAccount() {
            const data = {
                phone: document.getElementById('loginPhone').value,
                api_id: parseInt(document.getElementById('loginApiId').value),
                api_hash: document.getElementById('loginApiHash').value,
                proxy: document.getElementById('loginProxy').value
            };
            if (!data.phone) { alert('ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑'); return; }
            await fetch('/api/accounts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            hideModal();
            loadAccounts();
        }
        
        loadAccounts();
    </script>
</body>
</html>
